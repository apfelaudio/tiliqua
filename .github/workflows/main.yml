name: build & test

on: [push]

jobs:
  ubuntu-bitstream-xbeam:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set oss-cad-suite vars (for cache)
        run: |
          echo >> $GITHUB_ENV OSS_CAD_SUITE_DATE=$(cat gateware/.oss-cad-suite-version)
      - name: Cache OSS CAD Suite
        id: cache-oss-cad-suite
        uses: actions/cache@v4
        with:
          path: ~/cache/
          key: ${{ runner.os }}-${{ env.OSS_CAD_SUITE_DATE }}
      - name: Download OSS CAD Suite
        if: steps.cache-oss-cad-suite.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/cache/oss-cad-suite-linux-x64
          wget https://github.com/YosysHQ/oss-cad-suite-build/releases/download/$OSS_CAD_SUITE_DATE/oss-cad-suite-linux-x64-$(echo $OSS_CAD_SUITE_DATE | sed s/-//g).tgz -nv -O oss-cad-suite-linux-x64.tar.gz
          tar -xzf oss-cad-suite-linux-x64.tar.gz -C ~/cache/oss-cad-suite-linux-x64
      - name: Set OSS CAD Suite path
        run: echo >> $GITHUB_PATH `echo ~/cache/oss-cad-suite-linux-x64/*/bin`
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools
          target: riscv32im-unknown-none-elf
      - run: cargo install cargo-binutils form
      # https://github.com/rust-embedded/svd2rust/issues/863
      - run: cargo install svd2rust --locked
      - run: git submodule update --init --recursive
      - uses: pdm-project/setup-pdm@v4
        with:
          cache: true
          cache-dependency-path: gateware/pdm.lock
      - run: |
          pdm install
        working-directory: gateware
      - run: |
          pdm xbeam build
        working-directory: gateware
      - uses: actions/upload-artifact@v4
        with:
          name: example-xbeam.bit
          path: gateware/build/top.bit
