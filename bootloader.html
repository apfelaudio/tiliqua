<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bootloader &mdash; Tiliqua Project  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/platformpicker.css" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/platformpicker.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Top-level projects" href="top.html" />
    <link rel="prev" title="Tiliqua SoC designs" href="soc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="cover.html" class="icon icon-home">
            Tiliqua Project
              <img src="_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tiliqua Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hardware.html">Hardware overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="technical.html">Hardware details</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingstarted.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="soc.html">Tiliqua SoC designs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Bootloader</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#interface">Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-and-implementation">Setup and implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#first-time-setup">First-time setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bitstream-manifest">Bitstream Manifest</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ecp5-implementation">ECP5 implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rp2040-implementation">RP2040 implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#recording-new-jtag-streams-for-rp2040">Recording new JTAG streams for RP2040</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="top.html">Top-level projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsp.html">Tiliqua DSP Library</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apfaudio/tiliqua">(external) GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.crowdsupply.com/apfaudio/tiliqua">(external) CrowdSupply</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apf.audio/">(external) apf.audio</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="cover.html">Tiliqua Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="cover.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tiliqua Manual</a></li>
      <li class="breadcrumb-item active">Bootloader</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/bootloader.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bootloader">
<h1>Bootloader<a class="headerlink" href="#bootloader" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>‘Bootloader’ is a bit of a misnomer, as what is currently implemented is more like a ‘bitstream selector’ (although a true USB bootloader is something in the works).</p>
</div>
<section id="interface">
<h2>Interface<a class="headerlink" href="#interface" title="Link to this heading"></a></h2>
<p>The bitstream selector allows you to arbitrarily select from one of 8 bitstreams after the Tiliqua powers on, without needing to connect a computer.</p>
<p>Put simply:</p>
<ul class="simple">
<li><p>When tiliqua boots, you can select a bitstream with the encoder (either using the display output, or by reading the currently lit LED if no display is connected).</p></li>
<li><p>When you select a bitstream (press encoder), the FPGA reconfigures itself and enters the selected bitstream.</p></li>
<li><p>From the new bitstream, you can always go back to the bitstream selector by holding the encoder for 3sec (this is built into the logic of every bitstream).</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The bitstream selector will not reboot correctly if you have
the <code class="code highlight py python docutils literal highlight-python"><span class="n">dbg</span></code> USB port connected. The assumption is you’re flashing
development bitstreams to SRAM in that scenario anyway.</p>
</div>
</section>
<section id="setup-and-implementation">
<h2>Setup and implementation<a class="headerlink" href="#setup-and-implementation" title="Link to this heading"></a></h2>
<p>The bitstream selector consists of 2 key components that work together:</p>
<ul class="simple">
<li><p>The RP2040 firmware (<a class="reference external" href="https://github.com/apfaudio/apfelbug">apfelbug - fork of dirtyJTAG</a>)</p></li>
<li><p>The <a class="reference external" href="https://github.com/apfaudio/tiliqua/tree/main/gateware/src/top/bootloader">bootloader</a> top-level bitstream.</p></li>
</ul>
<p>The difficulty here is that the ECP5 multiboot mechanism only supports rebooting from one bitstream to a single fixed new address <code class="code docutils literal notranslate"><span class="pre">bootaddr</span></code>, which is not sufficient for arbitrary bitstream selection. It would in theory have been possible to set up a ‘bitstream chain’, however that would require all bitstreams to be correctly flashed with the correct addresses at all times, which is not ideal for development. So, the solution here is more complicated, but hopefully more robust to ‘less trustworthy’ bitstreams.</p>
<section id="first-time-setup">
<h3>First-time setup<a class="headerlink" href="#first-time-setup" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Build and flash the <a class="reference external" href="https://github.com/apfaudio/apfelbug">apfelbug</a> project to the RP2040 (hold RP2040 BOOTSEL during power on, copy the <code class="code docutils literal notranslate"><span class="pre">build/*.uf2</span></code> to the usb storage device and reset)</p></li>
<li><dl class="simple">
<dt>On the Tiliqua ECP5 SPI flash:</dt><dd><ul>
<li><p>Using <code class="code docutils literal notranslate"><span class="pre">openFPGALoader</span> <span class="pre">-c</span> <span class="pre">dirtyJtag</span> <span class="pre">&lt;bitstream&gt;</span> <span class="pre">-f</span> <span class="pre">o</span> <span class="pre">&lt;offset&gt;</span></code></p></li>
<li><p>flash <code class="code docutils literal notranslate"><span class="pre">bootloader</span></code> bitstream to offset 0x0</p></li>
<li><p>flash user bitstreams to 0x100000, 0x200000, 0x300000 … and so on (1MB spacing)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>DISCONNECT USB DBG port, reboot Tiliqua</dt><dd><ul>
<li><p>Currently <code class="code docutils literal notranslate"><span class="pre">apfelbug</span></code> only works correctly with the DBG connector DISCONNECTED or with the UART port open on Linux and CONNECTED. Do not have the USB DBG connected without the UART0 open with <code class="code docutils literal notranslate"><span class="pre">picocom</span></code> or so.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Now when Tiliqua boots you will enter the bootloader. Use the encoder to select an image. Hold the encoder for &gt;3sec in any image to go back to the bootloader.</p></li>
</ul>
</section>
<section id="bitstream-manifest">
<h3>Bitstream Manifest<a class="headerlink" href="#bitstream-manifest" title="Link to this heading"></a></h3>
<p>By default the bootloader screen will report all bitstream names as <code class="code docutils literal notranslate"><span class="pre">&lt;unknown&gt;</span></code>. The <code class="code docutils literal notranslate"><span class="pre">bootloader</span></code> bitstream can optionally read from a JSON manifest stored at the end of SPI flash called a ‘Bitstream Manifest’. Such a <code class="code docutils literal notranslate"><span class="pre">manifest.json</span></code> file can be copied from <code class="code docutils literal notranslate"><span class="pre">gateware/src/top/bootloader/fw/example-manifest.json</span></code>. You can flash this to the end of the SPI flash so the bootloader knows what each bitstream should be called.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>openFPGALoader<span class="w"> </span>-c<span class="w"> </span>dirtyJtag<span class="w"> </span>-f<span class="w"> </span>-o<span class="w"> </span>0xfff000<span class="w"> </span>--file-type<span class="w"> </span>raw<span class="w"> </span>manifest.json
</pre></div>
</div>
<p>Note: this address <code class="code docutils literal notranslate"><span class="pre">0xfff000</span></code> comes from <code class="code docutils literal notranslate"><span class="pre">src/tiliqua/tiliqua_soc.py</span></code>.</p>
<p>Assuming the bootloader bitstream is correctly already flashed to 0x0, this command will also reset the FPGA, re-enter the bootloader, and display the updated bitstream manifest.</p>
<p>At the moment, the bootloader itself does no verification that there are actually bitstreams flashed to each slot corresponding to the names. If a bitstream is not actually in a designated slot or is corrupt, selecting the bad slot will simply reboot the FPGA and re-enter the bootloader.</p>
</section>
<section id="ecp5-implementation">
<h3>ECP5 implementation<a class="headerlink" href="#ecp5-implementation" title="Link to this heading"></a></h3>
<p>The ECP5 <code class="code docutils literal notranslate"><span class="pre">bootloader</span></code> bitstream does nothing except tell the RP2040 that it wants to be rebooted into a new bitstream (over UART). However, the user bitstreams are responsible for asserting PROGRAMN when the encoder is held, to reconfigure back to the bootloader bitstream.</p>
</section>
<section id="rp2040-implementation">
<h3>RP2040 implementation<a class="headerlink" href="#rp2040-implementation" title="Link to this heading"></a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">apfelbug</span></code> firmware includes the same features as <code class="code docutils literal notranslate"><span class="pre">pico-dirtyjtag</span></code> (USB-JTAG and USB-UART bridge), with some additions:</p>
<ul class="simple">
<li><p>UART traffic is inspected to look for keywords.</p></li>
<li><p>If a keyword is encountered e.g. <code class="code docutils literal notranslate"><span class="pre">BITSTREAM1</span></code>, a pre-recorded JTAG stream stored on the RP2040’s SPI flash is decompressed and replayed. The JTAG streams are instances of the <a class="reference external" href="https://github.com/apfaudio/tiliqua/blob/main/gateware/src/top/bootstub/top.py">bootstub</a> top-level bitstream. These are tiny bitstreams that are programmed directly into SRAM with the target <code class="code docutils literal notranslate"><span class="pre">bootaddr</span></code> and PROGRAMN assertion.</p></li>
<li><p>This facilitates ECP5 multiboot (jumping to arbitrary bitstreams) without needing to write to the ECP5’s SPI flash and exhausting write cycles.</p></li>
</ul>
</section>
<section id="recording-new-jtag-streams-for-rp2040">
<h3>Recording new JTAG streams for RP2040<a class="headerlink" href="#recording-new-jtag-streams-for-rp2040" title="Link to this heading"></a></h3>
<p>TODO documentation, not necessary to change this for any ordinary usecase. Update this if needed for SoldierCrab R3.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="soc.html" class="btn btn-neutral float-left" title="Tiliqua SoC designs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="top.html" class="btn btn-neutral float-right" title="Top-level projects" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024—2025, S. Holzapfel and Tiliqua contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>